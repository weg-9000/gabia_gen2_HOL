# Lab 08: 공인 IP (Elastic IP) 관리

## 📚 목차
- [학습 목표](#학습-목표)
- [왜 이 Lab이 필요한가?](#왜-이-lab이-필요한가)
- [배경 지식](#배경-지식)
- [실습 단계](#실습-단계)
- [심화 이해](#심화-이해)
- [트러블슈팅](#트러블슈팅)
- [다음 단계](#다음-단계)

---

## 🎯 학습 목표

이 Lab을 완료하면 다음을 할 수 있습니다:
- 동적 IP와 탄력적 IP(Elastic IP)의 차이를 이해합니다
- 탄력적 IP를 생성하고 서버에 연결할 수 있습니다
- DNS와 연동하여 도메인 기반 접속을 구성합니다
- IP 주소 관리의 모범 사례를 적용합니다

**소요 시간**: 10-15분
**난이도**: 초급
**선행 조건**: Lab 01 완료

---

## 🤔 왜 이 Lab이 필요한가?

### 동적 IP의 문제점

```
┌────────────────────────────────────────────────────────────┐
│                    동적 IP의 문제                           │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   서버 시작                                                 │
│   ┌─────────────┐                                          │
│   │   Server    │  IP: 123.45.67.89                        │
│   │   Running   │                                          │
│   └─────────────┘                                          │
│         │                                                  │
│         │ 서버 재시작 (점검, 업데이트 등)                    │
│         ↓                                                  │
│   ┌─────────────┐                                          │
│   │   Server    │  IP: 123.45.67.99 ← 변경됨!              │
│   │   Running   │                                          │
│   └─────────────┘                                          │
│                                                            │
│   문제 발생:                                                │
│   DNS 레코드 수동 업데이트 필요                          │
│   방화벽 화이트리스트 재설정 필요                         │
│   연동 시스템 설정 변경 필요                             │
│   서비스 중단 시간 발생                                  │
└────────────────────────────────────────────────────────────┘
```

### 실무 시나리오

**1. DNS 연동 문제**
```
도메인: api.myshop.com
A 레코드: 123.45.67.89

서버 재시작 후:
- 새 IP: 123.45.67.99
- DNS: 여전히 123.45.67.89 (구 IP)
- 결과: 사용자 접속 불가! 

DNS TTL 동안 캐시 문제:
- TTL 3600초 (1시간)
- 최대 1시간 동안 접속 불가 가능
```

**2. 외부 시스템 연동**
```
결제 게이트웨이 화이트리스트:
- 등록된 IP: 123.45.67.89
- 서버 IP 변경 시 결제 실패

API 파트너사 연동:
- IP 기반 인증 시스템
- IP 변경 시 연동 차단
```

**3. 보안 정책**
```
사내 방화벽:
- 서버 IP 허용 설정
- IP 변경 시 접근 차단

클라우드 보안 그룹:
- 소스 IP 기반 규칙
- IP 변경 시 규칙 무효화
```

### 탄력적 IP의 해결책

```
┌────────────────────────────────────────────────────────────┐
│                  탄력적 IP (Elastic IP)                    │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   탄력적 IP 할당                                           │
│   ┌──────────────────┐                                     │
│   │  Elastic IP      │                                     │
│   │  203.0.113.50    │ ← 고정! 절대 변경 안 됨             │
│   └────────┬─────────┘                                     │
│            │ 연결                                          │
│            ↓                                               │
│   ┌─────────────┐                                          │
│   │   Server A  │                                          │
│   │   Running   │                                          │
│   └─────────────┘                                          │
│                                                            │
│   서버 재시작, 또는 다른 서버로 이동                        │
│            │                                               │
│            ↓                                               │
│   ┌─────────────┐                                          │
│   │   Server B  │  여전히 203.0.113.50                  │
│   │   Running   │                                          │
│   └─────────────┘                                          │
│                                                            │
│   장점:                                                    │
│   DNS 변경 불필요                                       │
│   방화벽 설정 유지                                      │
│   무중단 서버 교체 가능                                 │
│   장애 시 빠른 복구                                     │
└────────────────────────────────────────────────────────────┘
```

---

## 📖 배경 지식

### 1. IP 주소의 종류

```
┌─────────────────────────────────────────────────────────────┐
│                    IP 주소 분류                              │
├──────────────────┬──────────────────────────────────────────┤
│                  │                                          │
│   공인 IP        │   인터넷에서 직접 접근 가능              │
│   (Public IP)    │   전 세계에서 유일한 주소                │
│                  │   예: 203.0.113.50                       │
│                  │                                          │
├──────────────────┼──────────────────────────────────────────┤
│                  │                                          │
│   사설 IP        │   내부 네트워크에서만 사용               │
│   (Private IP)   │   인터넷에서 직접 접근 불가              │
│                  │   예: 10.0.2.10, 192.168.1.100          │
│                  │                                          │
├──────────────────┼──────────────────────────────────────────┤
│                  │                                          │
│   동적 IP        │   서버 시작 시 자동 할당                 │
│   (Dynamic IP)   │   재시작 시 변경 가능                    │
│                  │                                          │
├──────────────────┼──────────────────────────────────────────┤
│                  │                                          │
│   탄력적 IP      │   사용자가 명시적으로 할당               │
│   (Elastic IP)   │   해제 전까지 영구 유지                  │
│                  │   다른 서버로 이동 가능                  │
│                  │                                          │
└──────────────────┴──────────────────────────────────────────┘
```

### 2. 탄력적 IP의 특징

```
1. 영속성 (Persistence)
   - 계정에 할당되면 해제 전까지 유지
   - 서버와 독립적으로 존재
   - 서버 삭제해도 IP는 유지

2. 이동성 (Portability)
   - 한 서버에서 다른 서버로 빠르게 이동
   - 장애 시 대체 서버로 전환 용이
   - Blue-Green 배포에 활용

3. 연결/해제
   - 언제든 서버에 연결/해제 가능
   - 연결 시 기존 동적 IP는 자동 해제
   - 해제 시 서버는 새 동적 IP 할당받음

4. 비용
   - 서버에 연결되어 사용 중: 무료 (또는 저렴)
   - 할당만 하고 미사용 시: 비용 발생
```

### 3. 탄력적 IP vs 동적 IP

| 항목 | 동적 IP | 탄력적 IP |
|------|---------|-----------|
| **할당 방식** | 자동 (서버 시작 시) | 수동 (명시적 할당) |
| **지속성** | 서버 중지 시 해제됨 | 명시적 해제 전까지 유지 |
| **변경 가능성** | 재시작 시 변경 가능 | 고정 |
| **이동성** | 불가 | 다른 서버로 이동 가능 |
| **비용** | 무료 | 미사용 시 비용 발생 |
| **사용 사례** | 개발/테스트 | 프로덕션, DNS 연동 |

### 4. 탄력적 IP 사용 사례

```
┌─────────────────────────────────────────────────────────────┐
│  사용 사례 1: DNS 연동                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   DNS                     탄력적 IP         서버            │
│   ┌─────────────┐        ┌─────────┐      ┌─────────┐     │
│   │ A: api.shop │───────→│203.0.113│─────→│  API    │     │
│   │    .com     │        │   .50   │      │ Server  │     │
│   └─────────────┘        └─────────┘      └─────────┘     │
│                                                             │
│   서버 교체 시에도 DNS 변경 불필요                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  사용 사례 2: 장애 복구 (Failover)                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   정상 상태:                                                │
│   ┌─────────────┐                                          │
│   │ EIP: .50    │────→ Server A (Active)                   │
│   └─────────────┘                                          │
│                        Server B (Standby)                   │
│                                                             │
│   장애 발생 시:                                             │
│   ┌─────────────┐                                          │
│   │ EIP: .50    │      Server A (Down)                  │
│   └─────────────┘                                          │
│         │                                                   │
│         └─────────────→ Server B (Active)               │
│                                                             │
│   IP 이동으로 빠른 복구 (수 초)                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  사용 사례 3: Blue-Green 배포                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   배포 전:                                                  │
│   EIP ────→ Blue (v1.0)                                    │
│             Green (v2.0) ← 새 버전 준비                     │
│                                                             │
│   배포 (EIP 전환):                                          │
│   EIP ────→ Green (v2.0)                                │
│             Blue (v1.0) ← 롤백용 대기                       │
│                                                             │
│   무중단 배포 가능                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 실습 단계

### 사전 준비

```bash
# 필요 조건
Lab 01에서 생성한 서버
가비아 클라우드 콘솔 접속
```

### 1단계: 현재 IP 확인

#### 서버의 현재 IP 확인

```bash
# 콘솔에서 확인
콘솔 → 컴퓨트 → 서버 → 서버 상세 → 공인 IP 확인

# 또는 서버에서 직접 확인
ssh ubuntu@[current-ip]
curl ifconfig.me
```

#### 동적 IP 확인

```
현재 IP: 123.45.67.89 (동적)
특징: 서버 재시작 시 변경될 수 있음
```

### 2단계: 탄력적 IP 생성

#### 콘솔에서 탄력적 IP 할당

1. **탄력적 IP 메뉴 이동**
   ```
   콘솔 → 네트워크 → VPC → 탄력적 IP
   ```

2. **탄력적 IP 할당**
   ```
   + 탄력적 IP 할당 버튼 클릭
   ```

3. **정보 입력**
   ```
   이름: shop-api-eip
   설명: 쇼핑몰 API 서버용 공인 IP
   ```

4. **할당 확인**
   ```
   IP 주소: 203.0.113.50 (예시)
   상태: 할당됨 (미연결)
   ```

### 3단계: 서버에 탄력적 IP 연결

#### 콘솔에서 연결

1. **탄력적 IP 선택**
   ```
   shop-api-eip 선택 → 연결 버튼 클릭
   ```

2. **대상 서버 선택**
   ```
   대상 유형: 서버
   대상 서버: shop-server (Lab 01에서 생성)
   ```

3. **연결 확인**
   ```
   상태: 연결됨
   연결된 리소스: shop-server
   ```

#### 연결 결과

```
┌────────────────────────────────────────────────────────┐
│  탄력적 IP 연결 결과                                   │
├────────────────────────────────────────────────────────┤
│                                                        │
│  Before:                                               │
│  ┌─────────────┐                                       │
│  │ shop-server │  동적 IP: 123.45.67.89               │
│  └─────────────┘                                       │
│                                                        │
│  After:                                                │
│  ┌─────────────┐                                       │
│  │ shop-server │  탄력적 IP: 203.0.113.50             │
│  └─────────────┘                                       │
│                                                        │
│  * 기존 동적 IP는 자동 해제됨                          │
└────────────────────────────────────────────────────────┘
```

### 4단계: 연결 테스트

#### SSH 접속 테스트

```bash
# 새 탄력적 IP로 SSH 접속
ssh -i ~/.ssh/gabia-key.pem ubuntu@203.0.113.50

# 접속 성공!
Welcome to Ubuntu 22.04.3 LTS
```

#### 쇼핑몰 API 테스트

```bash
# API 접속 테스트
curl http://203.0.113.50:8000/docs

# 또는 제품 조회
curl http://203.0.113.50:8000/products

# 예상 결과
[{"id":1,"name":"노트북","price":1200000}, ...]
```

### 5단계: DNS 연동 (선택)

도메인이 있는 경우 DNS를 연동합니다.

#### A 레코드 설정

```
도메인 관리 콘솔 (예: 가비아 DNS)
│
├─ A 레코드 추가:
│   호스트: api
│   값: 203.0.113.50
│   TTL: 300
│
└─ 결과: api.mydomain.com → 203.0.113.50
```

#### DNS 전파 확인

```bash
# DNS 조회
nslookup api.mydomain.com

# 또는
dig api.mydomain.com

# 예상 결과
api.mydomain.com.   300   IN   A   203.0.113.50
```

#### 도메인으로 접속 테스트

```bash
# HTTPS 설정 전
curl http://api.mydomain.com:8000/products

# HTTPS 설정 후 (Lab 추가 필요)
curl https://api.mydomain.com/products
```

### 6단계: 서버 재시작 테스트

탄력적 IP가 재시작 후에도 유지되는지 확인합니다.

#### 서버 재시작

```bash
# 콘솔에서 재시작
콘솔 → 컴퓨트 → 서버 → shop-server → 재시작

# 또는 서버에서 직접
sudo reboot
```

#### IP 유지 확인

```bash
# 재시작 후 (1-2분 대기)
ssh -i ~/.ssh/gabia-key.pem ubuntu@203.0.113.50

# 접속 성공! IP가 유지됨 
curl ifconfig.me
# 203.0.113.50
```

---

## 🔍 심화 이해

### 1. 탄력적 IP 비용 구조

```
┌────────────────────────────────────────────────────────────┐
│                    비용 구조                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  연결된 상태 (사용 중):                                     │
│  ┌─────────────┐                                           │
│  │    EIP      │────→ Server (Running)                     │
│  └─────────────┘                                           │
│  비용: 무료 또는 최소 비용                                  │
│                                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  미연결 상태 (유휴):                                        │
│  ┌─────────────┐                                           │
│  │    EIP      │     (연결 없음)                           │
│  └─────────────┘                                           │
│  비용: 시간당 과금 (예: 100원/시간)                         │
│  월간: 약 72,000원                                         │
│                                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  주의사항:                                               │
│  - 할당만 하고 사용하지 않으면 비용 발생                    │
│  - 사용하지 않는 EIP는 즉시 해제!                           │
│  - 정기적으로 유휴 EIP 점검                                 │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 2. 고가용성 구성

```
┌────────────────────────────────────────────────────────────┐
│              EIP + Health Check + Auto Failover            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   ┌─────────────────────────────────────────────────────┐ │
│   │              Health Check Service                    │ │
│   │  (외부 모니터링 또는 자체 스크립트)                  │ │
│   └──────────────────────┬──────────────────────────────┘ │
│                          │                                 │
│                          ↓ 장애 감지                       │
│                                                            │
│   ┌─────────┐       ┌─────────┐       ┌─────────┐        │
│   │   EIP   │       │ Primary │       │ Standby │        │
│   │ .50     │──────→│ Server  │       │ Server  │        │
│   └─────────┘       └─────────┘       └─────────┘        │
│        │                  │                 │             │
│        │                  ↓ 장애            │             │
│        │                                 │             │
│        │                                    │             │
│        └────────────────────────────────────┘             │
│                          │                                 │
│                          ↓ EIP 재연결                      │
│                                                            │
│   ┌─────────┐       ┌─────────┐       ┌─────────┐        │
│   │   EIP   │       │ Primary │       │ Standby │        │
│   │ .50     │       │ (Down)  │──────→│ (Active)│        │
│   └─────────┘       └─────────┘       └─────────┘        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 3. 탄력적 IP 관리 스크립트

#### EIP 상태 확인 스크립트

```bash
#!/bin/bash
# check_eip.sh - 유휴 EIP 확인

echo "=== 탄력적 IP 상태 확인 ==="

# CLI 사용 가능 시 (Lab 23 참조)
gabia-cli eip list --format table

# 또는 콘솔에서 확인:
# 콘솔 → 네트워크 → 탄력적 IP
# 상태가 "미연결"인 IP 확인
```

#### EIP 전환 스크립트 (장애 시)

```bash
#!/bin/bash
# failover_eip.sh - EIP 전환 스크립트

EIP_ID="eip-xxxxx"
NEW_SERVER_ID="server-yyyyy"

echo "EIP $EIP_ID를 서버 $NEW_SERVER_ID로 전환합니다..."

# 1. 현재 연결 해제
gabia-cli eip disassociate --eip-id $EIP_ID

# 2. 새 서버에 연결
gabia-cli eip associate --eip-id $EIP_ID --server-id $NEW_SERVER_ID

echo "전환 완료!"
```

### 4. 모범 사례

```
┌────────────────────────────────────────────────────────────┐
│                    EIP 관리 모범 사례                       │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  DO:                                                       │
│  프로덕션 서버에는 반드시 EIP 사용                      │
│  DNS 연동 서버에는 EIP 필수                             │
│  유휴 EIP 정기 점검 (비용 절감)                         │
│  EIP 명명 규칙 적용 (예: service-env-eip)              │
│  태그로 용도 명시                                       │
│                                                            │
│  DON'T:                                                    │
│  개발/테스트 서버에 EIP 과다 할당                       │
│  EIP를 할당만 하고 미사용 (비용 낭비)                   │
│  서버 삭제 시 EIP 해제 누락                             │
│  보안 그룹 없이 EIP만 연결                              │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 🔧 트러블슈팅

### 문제 1: EIP 연결 후 접속 안 됨

**증상**
```bash
ssh ubuntu@203.0.113.50
# Connection timed out
```

**확인 순서**

1. **서버 상태 확인**
   ```
   콘솔 → 서버 → 상태가 Running인지 확인
   ```

2. **보안 그룹 확인**
   ```
   SSH 포트 (22)가 허용되어 있는지 확인
   소스: 0.0.0.0/0 또는 내 IP
   ```

3. **EIP 연결 상태 확인**
   ```
   콘솔 → 탄력적 IP → 상태가 "연결됨"인지 확인
   ```

4. **네트워크 확인**
   ```bash
   # 로컬에서 ping 테스트
   ping 203.0.113.50

   # ICMP가 차단된 경우
   telnet 203.0.113.50 22
   ```

### 문제 2: 기존 동적 IP로 접속됨

**증상**
```bash
# EIP 연결 후에도 curl ifconfig.me 결과가 동적 IP
curl ifconfig.me
# 123.45.67.89 (예상: 203.0.113.50)
```

**원인**
- EIP 연결이 완료되지 않음
- 캐시된 DNS/라우팅

**해결**
```bash
# 1. 콘솔에서 EIP 연결 상태 재확인

# 2. 서버 네트워크 재시작
sudo systemctl restart networking
# 또는
sudo netplan apply

# 3. 다시 확인
curl ifconfig.me
```

### 문제 3: EIP 할당 실패

**증상**
```
오류: 탄력적 IP 할당 한도에 도달했습니다.
```

**해결**
```
1. 유휴 EIP 확인 및 해제
   콘솔 → 탄력적 IP → 미연결 EIP 해제

2. 할당량 증가 요청
   고객센터 → 리소스 할당량 증가 요청
```

### 문제 4: DNS 전파 지연

**증상**
```bash
nslookup api.mydomain.com
# 여전히 구 IP 표시
```

**해결**
```bash
# 1. TTL 확인
dig api.mydomain.com

# 2. DNS 캐시 초기화 (로컬)
# Windows
ipconfig /flushdns

# Mac
sudo dscacheutil -flushcache

# 3. 다른 DNS 서버로 확인
nslookup api.mydomain.com 8.8.8.8
```

### 문제 5: EIP 해제 안 됨

**증상**
```
오류: 연결된 리소스가 있어 해제할 수 없습니다.
```

**해결**
```
1. 먼저 연결 해제
   탄력적 IP → 연결 해제

2. 그 다음 해제
   탄력적 IP → 해제
```

---

## 📚 다음 단계

### Lab 09: 보안 그룹
보안 그룹을 설정하여 트래픽을 제어합니다.

### Lab 10: VPC Peering
VPC 간 연결을 구성합니다.

### 실습 완료 체크리스트

```
동적 IP와 탄력적 IP 차이 이해
탄력적 IP 할당
서버에 탄력적 IP 연결
SSH 접속 테스트
쇼핑몰 API 접속 테스트
서버 재시작 후 IP 유지 확인
(선택) DNS 연동
```

---

## 📖 참고 자료

### 가비아 클라우드 공식 문서
- [탄력적 IP 개요](https://customer.gabia.com/manual/cloud/21025)
- [탄력적 IP 관리](https://customer.gabia.com/manual/cloud/21025/21340)

### 추가 학습 자료
- [IP 주소 개념](https://www.cloudflare.com/learning/dns/glossary/what-is-my-ip-address/)
- [DNS 동작 원리](https://www.cloudflare.com/learning/dns/what-is-dns/)

---

**예상 비용**: 사용 중 무료, 미사용 시 시간당 약 100원
**다음 Lab**: [Lab 09: 보안 그룹](../lab09-security-group/README.md)
