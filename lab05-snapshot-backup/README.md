# Lab 05: 스냅샷 및 이미지

## 학습 목표

- 블록 스토리지 스냅샷 생성 및 복원
- 스냅샷으로 볼륨 및 서버 생성
- 서버 이미지 생성 및 활용

**소요 시간**: 20분
**난이도**: 초급

## 사전 준비

- Lab 01 완료 (서버 생성)
- Lab 03 완료 (블록 스토리지)

---

## 실습 단계

### 1. 블록 스토리지 스냅샷 생성

```
콘솔 > 스토리지 > 블록 스토리지 > shop-data-storage > 스냅샷 생성

이름: shop-data-snapshot-20260125
```

조건:
- 생성 가능 상태: 사용 가능, 사용 중
- 서버 연결 상태에서는 데이터 무결성 미보장

권장: 데이터 무결성을 위해 서비스 정지 후 생성
```bash
# PostgreSQL 정지
sudo systemctl stop postgresql

# 콘솔에서 스냅샷 생성

# PostgreSQL 시작
sudo systemctl start postgresql
```

### 2. 스냅샷 상태 확인

```
콘솔 > 스토리지 > 스냅샷

상태: 운영 중
원본: shop-data-storage
용량: 100GB
```

| 상태 | 설명 |
|------|------|
| 생성 중 | 스냅샷 생성 진행 중 |
| 운영 중 | 정상, 복원 가능 |
| 삭제 중 | 삭제 진행 중 |

### 3. 스냅샷으로 볼륨 생성

```
콘솔 > 스토리지 > 스냅샷 > shop-data-snapshot-20260125 > 볼륨 생성

이름: shop-data-restored
용량: 100GB (원본과 동일 이상)
```

### 4. 복원된 볼륨 서버 연결

```
콘솔 > 스토리지 > 블록 스토리지 > shop-data-restored > 서버 연결

서버: shop-server-02 (새 서버)
```

### 5. 복원 확인

```bash
ssh -i lab-keypair.pem ubuntu@[서버IP]

# 디바이스 확인
lsblk

# 마운트
sudo mkdir -p /mnt/restored
sudo mount /dev/vdb /mnt/restored

# 데이터 확인
ls -la /mnt/restored
```

---

## 스냅샷으로 서버 생성

### 1. 루트 스토리지 스냅샷 생성

```
콘솔 > 컴퓨팅 > 서버 > shop-server > 스토리지 > 루트 스토리지 > 스냅샷 생성

이름: shop-server-snapshot-20260125
```

조건:
- 루트 스토리지로 생성된 스냅샷만 서버 생성 가능
- 스냅샷 상태: 운영 중

### 2. 스냅샷으로 서버 생성

```
콘솔 > 컴퓨팅 > 서버 > 생성

이미지 선택: 스냅샷
스냅샷: shop-server-snapshot-20260125
이름: shop-server-from-snapshot
사양: 2vCore / 4GB
```

조건:
- 해당 프로젝트 내 존재하는 스냅샷만 선택 가능
- 스냅샷으로 서버 생성 시 다량 생성 불가

### 3. 서버 확인

```bash
ssh -i lab-keypair.pem ubuntu@[새서버IP]

# 기존 데이터 확인
ls -la /var/www/html
cat /etc/hostname
```

---

## 서버 이미지 생성

### 1. 이미지 생성

```
콘솔 > 컴퓨팅 > 서버 > shop-server > 이미지 생성

이름: shop-server-image-v1
설명: Nginx + PostgreSQL 설치 완료
```

조건:
- 서버 상태: 정지됨 권장
- 운영 중 생성 시 데이터 무결성 미보장

### 2. 이미지 확인

```
콘솔 > 컴퓨팅 > 이미지 > 내 이미지

이름: shop-server-image-v1
상태: 사용 가능
용량: 50GB
```

### 3. 이미지로 서버 생성

```
콘솔 > 컴퓨팅 > 서버 > 생성

이미지 선택: 내 이미지
이미지: shop-server-image-v1
이름: shop-server-from-image
사양: 2vCore / 4GB
```

---

## 스냅샷 삭제

### 삭제 조건

- 원본 스토리지 삭제 시 스냅샷도 함께 삭제
- 스냅샷 먼저 삭제 후 원본 삭제 권장

### 삭제 절차

```
콘솔 > 스토리지 > 스냅샷 > shop-data-snapshot-20260125 > 삭제
```

---

## 트러블슈팅

| 문제 | 원인 | 해결 |
|------|------|------|
| 스냅샷 생성 실패 | 스토리지 상태 이상 | 사용 가능/사용 중 상태 확인 |
| 서버 생성 불가 | 데이터 스토리지 스냅샷 | 루트 스토리지 스냅샷만 서버 생성 가능 |
| 스냅샷 목록 미노출 | 다른 프로젝트 | 동일 프로젝트 내 스냅샷만 표시 |
| 원본 삭제 불가 | 스냅샷 존재 | 스냅샷 먼저 삭제 |
| 이미지 생성 실패 | 서버 운영 중 | 서버 정지 후 재시도 |
| 복원 데이터 손상 | 무결성 미보장 | 서비스 정지 후 스냅샷 생성 |

---

## 완료 체크리스트

```
[ ] 블록 스토리지 스냅샷 생성
[ ] 스냅샷 상태 확인 (운영 중)
[ ] 스냅샷으로 볼륨 생성
[ ] 복원된 볼륨 서버 연결 및 확인
[ ] 루트 스토리지 스냅샷 생성
[ ] 스냅샷으로 서버 생성
[ ] 서버 이미지 생성
[ ] 이미지로 서버 생성
[ ] 스냅샷 삭제 (선택)
```

---

## 스냅샷 vs 이미지

| 구분 | 스냅샷 | 이미지 |
|------|--------|--------|
| 대상 | 스토리지 (볼륨) | 서버 전체 |
| 용도 | 데이터 복원, 볼륨 복제 | 서버 복제, 템플릿 |
| 복원 | 볼륨 생성, 서버 생성 (루트만) | 서버 생성 |
| 원본 삭제 | 스냅샷도 삭제 | 이미지 유지 |

---

**다음 Lab**: [Lab 06: VPC 및 서브넷 구성](../lab06-vpc-subnet/README.md)
